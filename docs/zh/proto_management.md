
# proto文件依赖管理

## 前言

tRPC使用protocol buffers作为缺省的接口定义语言（IDL）, 服务之间调用时, proto接口文件作为服务的对外用户界面, 应该有比较统一的管理方式。

常规的做法: 每个服务的proto文件自己管理, 服务需要互通时, 将proto文件copy一份, 然后通过protoc工具临时生成桩代码来使用, 这样的做法导致每个服务的proto文件出现多个副本, 不同proto文件的副本因为更新不及时, 导致上下游协议不一致，从而出现互通问题.

因此, tRPC-Cpp这里推荐的proto文件依赖管理方式是: 对于服务的提供方, 把需要对外的proto文件放到统一的远程仓库管理(比如:使用github的仓库或者内部私有的仓库); 对于服务的调用方, 只需要基于bazel构建工具自动拉取依赖的proto文件并生成桩代码即可.

## 基于bazel自动拉取远程proto文件的使用方式

步骤1: 拉取依赖服务的proto文件

在拉取之前, 需要确保依赖服务的proto文件已经在某个远程仓库中, 这里建议将服务对外的proto文件放到同一个远程仓库中, 虽然也可以通过直接拉取服务的代码仓库来获取依赖的proto文件, 但这里会拉取除了proto之外的很多不必要的代码文件.

然后在本项目的WORKSPACE文件中, 添加拉取proto文件统一管理的远程仓库的目标规则, 如下:


步骤2: 将proto目标加入到使用者的目标依赖中

这里主要是使用框架封装的trpc_proto_library规则, 实现proto目标之间的依赖管理.

比如: 本服务的proto文件中import了其它服务的proto文件, 可以参考以下的写法:

比如: 本服务的某个代码文件需要调用其它服务, 可以参考以下的写法:
